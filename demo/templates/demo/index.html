{% extends "base.html" %}

{% block title %}Web Push Notifications{% endblock %}

{% block content %}
<div class="min-h-screen py-12 px-4" x-data="notificationApp()">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-4xl font-bold text-gray-900 mb-8">Web Push Notifications</h1>

        <!-- Step 1: Enable Notifications -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Step 1: Enable Notifications</h2>

            <!-- Debug info -->
            <div class="mb-4 p-3 bg-gray-100 rounded text-xs space-y-1">
                <p><strong>Debug Info:</strong></p>
                <p>Notifications Enabled: <span x-text="notificationsEnabled"></span></p>
                <p>Has Subscription: <span x-text="subscriptionData ? 'Yes' : 'No'"></span></p>
                <p>Permission Denied: <span x-text="permissionDenied"></span></p>
                <p>VAPID Key: <span x-text="'{{ vapid_public_key }}' ? 'Present' : 'Missing'"></span></p>
            </div>

            <div x-show="!notificationsEnabled && !subscriptionData" class="space-y-4">
                <p class="text-gray-600">Click the button below to enable push notifications in your browser.</p>
                <button
                    type="button"
                    @click="requestNotificationPermission()"
                    @touchstart.passive="requestNotificationPermission()"
                    class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium">
                    Enable Notifications
                </button>
            </div>

            <div x-show="notificationsEnabled && subscriptionData" class="space-y-4">
                <p class="text-green-600 font-semibold">✓ Notifications enabled! You're ready to receive notifications.</p>
                <button
                    @click="showSubscription = !showSubscription"
                    class="text-sm text-blue-600 hover:underline">
                    <span x-show="!showSubscription">Show subscription details</span>
                    <span x-show="showSubscription">Hide subscription details</span>
                </button>
                <div x-show="showSubscription" class="mt-2">
                    <textarea
                        readonly
                        x-text="subscriptionData"
                        rows="6"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg text-xs font-mono bg-gray-50"></textarea>
                </div>
            </div>

            <div x-show="permissionDenied" class="space-y-4">
                <p class="text-red-600 font-semibold">⚠ Notification permission denied. Please enable notifications in your browser settings.</p>
            </div>
        </div>

        <!-- Step 2: Send Notification -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Step 2: Send Notification</h2>

            <form
                hx-post="{% url 'demo:send_notification' %}"
                hx-target="#notification-result"
                hx-indicator="#notification-spinner"
                hx-vals="js:{subscription: document.getElementById('subscription-field').value}"
                class="space-y-6">
                {% csrf_token %}

                <input type="hidden" id="subscription-field" name="subscription" x-model="subscriptionData">

                <div>
                    <label for="message" class="block text-sm font-medium text-gray-700 mb-2">
                        Message
                    </label>
                    <textarea
                        id="message"
                        name="message"
                        required
                        rows="4"
                        placeholder="Enter your notification message"
                        :disabled="!notificationsEnabled"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100"></textarea>
                </div>

                <div class="flex items-center space-x-4">
                    <button
                        type="submit"
                        :disabled="!notificationsEnabled"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Send Notification
                    </button>
                    <div id="notification-spinner" class="htmx-indicator">
                        <span class="text-gray-600">Sending...</span>
                    </div>
                </div>

                <div id="notification-result" class="mt-4"></div>
            </form>
        </div>

        <!-- Info Box -->
        <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h3 class="font-semibold text-blue-900 mb-2">How it works:</h3>
            <ol class="list-decimal list-inside space-y-1 text-sm text-blue-800">
                <li>Click "Enable Notifications" and allow notifications in your browser</li>
                <li>Your browser will subscribe to push notifications</li>
                <li>Enter a message and click "Send Notification"</li>
                <li>You'll receive a push notification in your browser!</li>
            </ol>
        </div>
    </div>
</div>

<style>
    .htmx-indicator {
        display: none;
    }
    .htmx-request .htmx-indicator {
        display: inline-block;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
const VAPID_PUBLIC_KEY = '{{ vapid_public_key }}';

function notificationApp() {
    return {
        notificationsEnabled: false,
        permissionDenied: false,
        subscriptionData: null,
        showSubscription: false,

        init() {
            console.log('Alpine.js initialized');
            console.log('VAPID key:', VAPID_PUBLIC_KEY);

            // Check if already subscribed on page load
            this.checkExistingSubscription();
        },

        async checkExistingSubscription() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                return;
            }

            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    const subscription = await registration.pushManager.getSubscription();
                    if (subscription) {
                        this.notificationsEnabled = true;
                        this.subscriptionData = JSON.stringify(subscription.toJSON());
                        console.log('Found existing subscription');
                    }
                }
            } catch (error) {
                console.error('Error checking subscription:', error);
            }
        },

        async requestNotificationPermission() {
            console.log('Button clicked - requesting permission');

            if (!('Notification' in window)) {
                alert('This browser does not support notifications');
                return;
            }

            if (!('serviceWorker' in navigator)) {
                alert('This browser does not support service workers');
                return;
            }

            if (!VAPID_PUBLIC_KEY) {
                alert('VAPID public key is missing. Please check server configuration.');
                return;
            }

            try {
                const permission = await Notification.requestPermission();
                console.log('Permission result:', permission);

                if (permission === 'granted') {
                    await this.subscribeUser();
                } else {
                    this.permissionDenied = true;
                }
            } catch (error) {
                console.error('Error requesting notification permission:', error);
                alert('Error: ' + error.message);
            }
        },

        async subscribeUser() {
            try {
                console.log('Registering service worker...');
                const registration = await navigator.serviceWorker.register('/service-worker.js');
                await navigator.serviceWorker.ready;
                console.log('Service worker ready');

                console.log('Subscribing to push...');
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: this.urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });

                this.notificationsEnabled = true;
                this.subscriptionData = JSON.stringify(subscription.toJSON());

                console.log('Push subscription successful:', subscription);
            } catch (error) {
                console.error('Error subscribing to push notifications:', error);
                alert('Error subscribing: ' + error.message);
            }
        },

        urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
    }
}
</script>
{% endblock %}
